<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Sale & Airdrop</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script type="module">
        import { EthereumProvider } from "https://esm.sh/@walletconnect/ethereum-provider@2.8.1";
        import { ethers } from "https://esm.sh/ethers";

        let provider, signer, contract;
        const contractAddress = "0x857C588260DDD9934F40c90BC41a1FA4Da2e8b31"; // Smart contract address
        const abi = [
            "function getAirdrop(address _refer) public returns (bool)",
            "function tokenSale(address _refer) public payable returns (bool)"
        ];

        async function connectWallet() {
            try {
                console.log("🔵 Menghubungkan Wallet...");
                provider = await EthereumProvider.init({
                    projectId: "2891d08b2b53e94b9c8ec031af88d6a9",
                    showQrModal: true,
                    chains: [56], // Binance Smart Chain (BSC)
                    rpcMap: { 56: "https://bsc-dataseed1.binance.org/" }
                });

                await provider.connect();
                signer = new ethers.BrowserProvider(provider).getSigner();
                contract = new ethers.Contract(contractAddress, abi, signer);

                const accounts = provider.accounts;
                if (!accounts || accounts.length === 0) {
                    alert("❌ Gagal mendapatkan akun wallet!");
                    return;
                }

                document.getElementById("walletAddress").innerText = `🔗 Wallet: ${accounts[0]}`;
                console.log("✅ Wallet Terhubung:", accounts[0]);

                document.getElementById("connectBtn").disabled = true;
                document.getElementById("disconnectBtn").disabled = false;
            } catch (error) {
                console.error("❌ Error saat menghubungkan wallet:", error);
                alert("⚠️ Gagal menghubungkan wallet!");
            }
        }

        function disconnectWallet() {
            if (provider) {
                provider.disconnect();
                document.getElementById("walletAddress").innerText = "🔗 Wallet: Not Connected";
                document.getElementById("connectBtn").disabled = false;
                document.getElementById("disconnectBtn").disabled = true;
                console.log("🔴 Wallet disconnected.");
            }
        }

        async function getAirdrop() {
            if (!signer || !contract) {
                alert("❌ Wallet belum terhubung! Coba hubungkan ulang.");
                return;
            }

            try {
                console.log("📢 Mengirim transaksi klaim airdrop...");
                const tx = await contract.getAirdrop(await signer.getAddress());
                console.log("✅ Transaksi terkirim:", tx);
                await tx.wait();
                alert(`✅ Airdrop berhasil! TX Hash: ${tx.hash}`);
            } catch (error) {
                console.error("❌ Gagal klaim airdrop:", error);
                alert("⚠️ Gagal klaim airdrop! Cek console.");
            }
        }

        async function buyToken() {
            if (!signer || !contract) {
                alert("❌ Wallet belum terhubung! Coba hubungkan ulang.");
                return;
            }

            try {
                let amount = document.getElementById("bnbAmount").value;
                if (!amount || parseFloat(amount) <= 0) {
                    alert("⚠️ Masukkan jumlah BNB yang valid!");
                    return;
                }

                console.log("📢 Mencoba membeli token...");
                const tx = await contract.tokenSale(await signer.getAddress(), { value: ethers.parseEther(amount) });
                console.log("✅ Transaksi pembelian terkirim:", tx);
                await tx.wait();
                alert(`✅ Pembelian berhasil! TX Hash: ${tx.hash}`);
            } catch (error) {
                console.error("❌ Gagal membeli token:", error);
                alert("⚠️ Gagal membeli token! Cek console.");
            }
        }

        async function generateReferralLink() {
            if (!signer) {
                alert("❌ Wallet belum terhubung!");
                return;
            }
            const address = await signer.getAddress();
            document.getElementById("refLink").innerText = `${window.location.origin}?ref=${address}`;
        }

        function copyReferralLink() {
            let refText = document.getElementById("refLink").innerText;
            navigator.clipboard.writeText(refText).then(() => {
                alert("🔗 Referral link copied!");
            });
        }

        window.connectWallet = connectWallet;
        window.disconnectWallet = disconnectWallet;
        window.getAirdrop = getAirdrop;
        window.buyToken = buyToken;
        window.generateReferralLink = generateReferralLink;
        window.copyReferralLink = copyReferralLink;
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        .container {
            max-width: 400px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        input {
            width: 90%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>🚀 Token Sale & Airdrop</h2>

        <button id="connectBtn" onclick="connectWallet()">🔗 Connect Wallet</button>
        <button id="disconnectBtn" onclick="disconnectWallet()" disabled>❌ Disconnect</button>
        <p id="walletAddress">🔗 Wallet: Not Connected</p>

        <h3>🎁 Claim Airdrop</h3>
        <button onclick="getAirdrop()">🚀 Claim Airdrop</button>

        <h3>💰 Buy Tokens</h3>
        <input type="number" id="bnbAmount" placeholder="Enter BNB amount">
        <button onclick="buyToken()">💵 Buy Token</button>

        <h3>🔗 Your Referral Link</h3>
        <p id="refLink">Not Available</p>
        <button onclick="generateReferralLink()">🔗 Generate Referral</button>
        <button onclick="copyReferralLink()">📋 Copy Link</button>
    </div>

</body>
</html>
