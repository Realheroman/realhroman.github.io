<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uji Koneksi MetaMask & WalletConnect</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider/dist/umd/index.min.js"></script>
</head>
<body>
    <h2>🔗 Uji Koneksi Wallet</h2>

    <!-- Tombol Koneksi -->
    <button id="connectMetaMask">🔗 Connect MetaMask</button>
    <button id="connectWalletConnect">🔗 Connect WalletConnect</button>
    <p id="walletStatus">⛔ Wallet belum terhubung</p>

    <h3>💰 Klaim Airdrop</h3>
    <button id="claimAirdrop">🚀 Klaim Airdrop</button>

    <h3>💵 Beli Token (Presale)</h3>
    <label for="bnbAmount">Masukkan jumlah BNB:</label>
    <input type="number" id="bnbAmount" step="0.01" min="0.01">
    <p>Token yang akan didapatkan: <span id="tokenAmount">0</span> $BWAR</p>
    <button id="buyToken">💳 Beli Token</button>

    <h3>🔗 Referral</h3>
    <p>Referral Anda: <span id="refLink">Belum dibuat</span></p>
    <button id="generateRef">🎁 Buat Referral</button>
    <button id="copyRef">📋 Salin Referral</button>

    <script>
        const contractAddress = "0x857C588260DDD9934F40c90BC41a1FA4Da2e8b31"; 
        const contractABI = [ /* MASUKKAN ABI DI SINI */ ]; 

        let web3;
        let userAccount = null;
        let provider;
        let referrer = null;

        // Konfigurasi WalletConnect v2
        const walletConnectProvider = new WalletConnectProvider.default({
            rpc: { 56: "https://bsc-dataseed.binance.org/" } // Binance Smart Chain
        });

        // 1️⃣ Ambil referral dari URL
        function getReferrerFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            referrer = urlParams.get("ref");
        }

        // 2️⃣ Fungsi koneksi wallet (MetaMask & WalletConnect)
        async function connectWallet(option) {
            if (option === "metamask") {
                if (window.ethereum) {
                    provider = window.ethereum;
                    web3 = new Web3(provider);
                    try {
                        const accounts = await provider.request({ method: "eth_requestAccounts" });
                        userAccount = accounts[0];
                        document.getElementById("walletStatus").innerText = `✅ Terhubung: ${userAccount}`;
                    } catch (error) {
                        console.error("User menolak koneksi wallet");
                    }
                } else {
                    alert("MetaMask tidak terdeteksi, silakan instal MetaMask.");
                }
            } else if (option === "walletconnect") {
                provider = walletConnectProvider;
                await provider.enable();
                web3 = new Web3(provider);
                const accounts = await web3.eth.getAccounts();
                userAccount = accounts[0];
                document.getElementById("walletStatus").innerText = `✅ Terhubung: ${userAccount}`;

                // Handle disconnect event
                provider.on("disconnect", () => {
                    alert("WalletConnect terputus");
                    location.reload();
                });
            }
        }

        // 3️⃣ Klaim Airdrop
        async function claimAirdrop() {
            if (!userAccount) return alert("Hubungkan wallet terlebih dahulu!");
            const contract = new web3.eth.Contract(contractABI, contractAddress);
            try {
                await contract.methods.getAirdrop(userAccount).send({ from: userAccount });
                alert("🎉 Airdrop berhasil diklaim!");
            } catch (error) {
                console.error(error);
                alert("Airdrop gagal diklaim!");
            }
        }

        // 4️⃣ Beli Token
        async function buyToken() {
            if (!userAccount) return alert("Hubungkan wallet terlebih dahulu!");
            const contract = new web3.eth.Contract(contractABI, contractAddress);
            let bnbAmount = document.getElementById("bnbAmount").value;
            if (bnbAmount < 0.01) return alert("Minimal pembelian adalah 0.01 BNB.");

            let tokenAmount = bnbAmount * 10000000; // 1 BNB = 10,000,000 $BWAR
            try {
                await contract.methods.tokenSale(userAccount, referrer || "0x0000000000000000000000000000000000000000").send({
                    from: userAccount,
                    value: web3.utils.toWei(bnbAmount, "ether")
                });
                alert(`✅ Berhasil membeli ${tokenAmount} $BWAR.`);
            } catch (error) {
                console.error(error);
                alert("Transaksi gagal!");
            }
        }

        // 5️⃣ Buat Link Referral
        async function generateReferralLink() {
            if (!userAccount) return alert("Hubungkan wallet terlebih dahulu!");
            let refLink = `${window.location.origin}?ref=${userAccount}`;
            document.getElementById("refLink").innerText = refLink;
        }

        // 6️⃣ Salin Referral Link
        function copyReferralLink() {
            let refText = document.getElementById("refLink").innerText;
            navigator.clipboard.writeText(refText).then(() => {
                alert("🔗 Referral link disalin!");
            });
        }

        // 7️⃣ Update jumlah token saat input BNB berubah
        document.getElementById("bnbAmount").addEventListener("input", function() {
            let bnb = this.value;
            let tokenAmount = bnb * 10000000; // 1 BNB = 10,000,000 $BWAR
            document.getElementById("tokenAmount").innerText = tokenAmount.toLocaleString();
        });

        // 8️⃣ Tambahkan event listener untuk tombol koneksi wallet
        document.getElementById("connectMetaMask").addEventListener("click", () => connectWallet("metamask"));
        document.getElementById("connectWalletConnect").addEventListener("click", () => connectWallet("walletconnect"));
        document.getElementById("claimAirdrop").addEventListener("click", claimAirdrop);
        document.getElementById("buyToken").addEventListener("click", buyToken);
        document.getElementById("generateRef").addEventListener("click", generateReferralLink);
        document.getElementById("copyRef").addEventListener("click", copyReferralLink);

        // 🔟 Ambil referral dari URL saat halaman dimuat
        window.onload = getReferrerFromURL;
    </script>
</body>
</html>
